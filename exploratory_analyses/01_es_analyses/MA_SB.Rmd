---
title: "Syntactic Boostrapping MA"
subtitle: "Data V2"
author: "Anjie Cao and Molly Lewis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc_float: yes
    code_folding: hide 
    number_sections: no
    toc: yes
---


```{r setup, include = F}
library(glue)
library(tidyverse)
library(googlesheets4)
library(metafor)
library(knitr)
library(gridExtra)
library(here)
library(dict)
library(heatmaply)
library(MuMIn)
library(glmulti)
GOOGLE_SHEET_ID <- "1kSL5lpmHcaw9lOp2dhJ_RH15REFe7oZVwMO1vJc930o"
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.height=6, fig.path='Figs/',
                     warning=FALSE, message=FALSE)
theme_set(theme_classic()) # sets global plot theme
```

```{r}
DATA_PATH <- here("data/processed/syntactic_bootstrapping_tidy_data.csv") # make all variables (i.e. things that might change) as capital letters at the top of the scripts

ma_data <- read_csv(DATA_PATH)   %>%
  filter(language == "English",
         population_type == "typically_developing", 
         stimuli_modality == "video"|stimuli_modality == "animation",
         !is.na(mean_age))

ma_data
```

# With Raw Calculation 
```{r}
ma_data <- ma_data %>% 
  mutate(
    d_calc_raw = case_when(
      !is.na(x_2_raw) & !is.na(sd_2_raw) ~ (x_1 - x_2_raw) / sqrt((sd_1^2 + sd_2_raw^2)/2),
      TRUE ~  NA_real_ 
    ), 
    d_var_calc_raw = case_when(
      !is.na(x_2_raw) & !is.na(sd_2_raw) ~  (1 / n_1) + (d_calc_raw ^ 2 / (2 * n_1)), 
      TRUE ~ NA_real_
    )) 

ma_data_with_raw <- ma_data %>% filter(!is.na(d_calc_raw))

cor.test(ma_data_with_raw$d_calc,
         ma_data_with_raw$d_calc_raw)

ma_data_with_raw
```




# Data Overview

```{r}
n_effect_sizes <- ma_data %>%
  filter(!is.na(d_calc)) %>%
  nrow()

n_papers <- ma_data %>%
  distinct(unique_id) %>%
  nrow()
```

There are `r n_effect_sizes` effect sizes collected from `r n_papers` different papers.

Here are the papers in this analysis:
```{r}
ma_data %>%
  count(short_cite) %>%
  arrange(-n) %>%
  DT::datatable()
```
# Forest plot 
```{r}
ma_model <- rma(ma_data$d_calc, ma_data$d_var_calc)
ma_model
forest(ma_model,
       header = T,
       slab = ma_data$unique_id,
       col = "red",
       cex = .7)

```
#funnel plot {.tabset}
## vanilla 
```{r}

ma_data %>% 
  mutate(color = ifelse(sentence_structure == "transitive", "red", "blue"),
         color_sample_size = ifelse(n_1 < 10, "red", ifelse(n_1 < 20, "orange", "yellow")),
         color_confidence = ifelse(inclusion_certainty == 1, "red", "black"))-> ma_data_funnel


ma_data_funnel %>% filter (abs(d_calc) < 5) -> ma_data_funnel_no_outlier

ss_colors <- ma_data_funnel$color
ss_colors_no_outlier <- ma_data_funnel_no_outlier$color 

ma_model_funnel <- rma(ma_data_funnel$d_calc, ma_data_funnel$d_var_calc)
ma_model_funnel_no_outlier <- rma(ma_data_funnel_no_outlier$d_calc, ma_data_funnel_no_outlier$d_var_calc)

f1<- funnel(ma_model_funnel, xlab = "Effect Size", col = ss_colors) 
legend("topright",bg = "white",legend = c("transitive","intransitive"),pch=16,col=c("red", "blue"))
title(main = "All effect sizes break down by sentence structure")

f2<- funnel(ma_model_funnel_no_outlier, xlab = "Effect Size", col = ss_colors_no_outlier) 
legend("topright",bg = "white",legend = c("transitive","intransitive"),pch=16,col=c("red", "blue"))
title(main = "effect sizes excluded outliers (abs <5) break down by sentence structure")
```

## take int occount sentence structure? 
```{r}
ma_model_sentence_structure <- rma(ma_data_funnel$d_calc~ma_data_funnel$sentence_structure, ma_data_funnel$d_var_calc)
ma_model_no_outlier_ss <- rma(ma_data_funnel_no_outlier$d_calc~ma_data_funnel_no_outlier$sentence_structure, ma_data_funnel_no_outlier$d_var_calc)

f3 <- funnel(ma_model_sentence_structure, xlab = "effect size", col = ss_colors)
f3_b <- funnel(ma_model_no_outlier_ss, xlab = "effect size", col = ss_colors_no_outlier)
```

## take int account sentence structure and age? 
```{r}
ma_model_ss_age <- rma(ma_data_funnel$d_calc~ma_data_funnel$sentence_structure + ma_data_funnel $mean_age, ma_data_funnel$d_var_calc)
ma_model_funnel_no_outlier_ss_age <- rma(ma_data_funnel_no_outlier$d_calc~ma_data_funnel_no_outlier$sentence_structure+ma_data_funnel_no_outlier$mean_age, ma_data_funnel_no_outlier$d_var_calc)



f4 <- funnel(ma_model_ss_age, xlab = "effect size", col = ss_colors)
f4_b <- funnel(ma_model_funnel_no_outlier_ss_age, xlab = "effect size", col = ss_colors_no_outlier)

```

# Variable Summary 
## Continuous Variables
```{r, fig.height =8 }
CONTINUOUS_VARS <- c("n_1", "x_1", "sd_1", "d_calc", "d_var_calc", "mean_age")

long_continuous <- ma_data %>%
  pivot_longer(cols = CONTINUOUS_VARS)

long_continuous %>%
  ggplot(aes(x = value)) +
  geom_histogram() + 
  facet_wrap(~ name, scale = "free_x") +
  labs(title = "Distribution of continuous measures")

long_continuous %>%
  group_by(name) %>%
  summarize(mean = mean(value),
            sd = sd(value)) %>%
  kable()

```  


## Categorical Variables 
```{r, fig.height = 10}
CATEGORICAL_VARS <- c("sentence_structure", "agent_argument_type", "patient_argument_type", "stimuli_actor",
                     "presentation_type", "character_identification",
                     "test_mass_or_distributed", "practice_phase", "test_method")

long_categorical <- ma_data %>%
  pivot_longer(cols = CATEGORICAL_VARS) %>%
  count(name, value) # this is a short cut for group_by() %>% summarize(count = n()) 

long_categorical %>%
  ggplot(aes(x = value, y = n)) +  
  facet_wrap(~ name, scale = "free_x") +
  geom_col(position = 'dodge',width=0.4) + 
  theme(text = element_text(size=8),
        axis.text.x = element_text(angle = 90, hjust = 1))  # rotate x-axis text
```

# Explore Moderators
## no moderators{.tabset}
### all
```{r}
m1 <- rma.mv(d_calc, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m1)
```

### <36
```{r}
ma_data_young <- ma_data %>%
    mutate(age_months = mean_age/30.44) %>% 
    filter(age_months < 36) 

m_young <- rma.mv(d_calc, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young)
summary(m_young)
```

### >= 36
```{r}
ma_data_old <- ma_data %>%
    mutate(age_months = mean_age/30.44) %>% 
    filter(age_months > 36 | age_months == 36) 

m_old <- rma.mv(d_calc, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_old)
```

## age only{.tabset}
### colored by unique_id
```{r}
ma_data %>% 
  ggplot(aes(x = mean_age/30.44, y = d_calc,color = unique_id)) +
  geom_point() +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (months)") 
```


### all
```{r}
ma_data %>% 
  ggplot(aes(x = mean_age/30.44, y = d_calc, size = n_1)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_smooth(color = "red") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (months)") +
  theme(legend.position = "none") 
```

```{r}
m_age <- rma.mv(d_calc ~ mean_age, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age)
```
```{r fig.width = 10, fig.height = 12}
forest(m_age,
       header = T,
       slab = ma_data$unique_id,
       col = "red",
       cex = .7
)

```

```{r}
funnel(m_age)
```

### young, < 36
 
```{r}
ma_data_young %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_smooth(color = "red") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days)") +
  theme(legend.position = "none") 
```

```{r fig.width = 10, fig.height = 12}
m_age_young <- rma.mv(d_calc ~ mean_age, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young)
summary(m_age_young)
```
```{r fig.width = 10, fig.height = 12}
forest(m_age_young,
       header = T,
       slab = ma_data_young$unique_id,
       col = "red",
       cex = .7
)

```


### old, >= 36

```{r}
ma_data_old %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_smooth(color = "red") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days)") +
  theme(legend.position = "none") 
```

```{r}
m_age_old <- rma.mv(d_calc ~ mean_age, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_age_old)
```




## age and test type {.tabset}
### all 
```{r}
ma_data %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = test_method)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown my method") 
```
```{r}
m_age_method <- rma.mv(d_calc ~ mean_age + test_method, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_method)
```

## age and sentence structure {.tabset}

### all
```{r}
ma_data %>% 
  filter(sentence_structure != "bare_verb") %>%
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, , color = sentence_structure)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days)") 
```

```{r}
m_age_sentence <- rma.mv(d_calc ~ mean_age + sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_sentence)
```
Interaction:
```{r}
m_age_sentence <- rma.mv(d_calc ~ mean_age * sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_sentence)
```

### < 36, young 
```{r}
ma_data_young_only <- ma_data %>%
    mutate(age_months = mean_age/30.44) %>% 
    filter(age_months < 36) 

ma_data_young_only %>% 
  filter(sentence_structure != "bare_verb") %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, , color = sentence_structure)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days)") 
```

```{r}
m_age_sentence_young <- rma.mv(d_calc ~ mean_age + sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_sentence_young)
```

interaction: 
```{r}
m_age_sentence_young <- rma.mv(d_calc ~ mean_age * sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_sentence_young)
```

### >= 36, old 
```{r}
ma_data_old <- ma_data %>%
    mutate(age_months = mean_age/30.44) %>% 
    filter(age_months > 36 | age_months == 36) 

ma_data_old %>% 
  filter(sentence_structure != "bare_verb") %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = sentence_structure)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days)") 
```

```{r}
m_age_sentence_old <- rma.mv(d_calc ~ mean_age + sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_age_sentence_old)
```
interaction 
```{r}
m_age_sentence_old <- rma.mv(d_calc ~ mean_age * sentence_structure, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_age_sentence_old)
```
## age with stimuli_actor  {.tabset}
### all 
```{r}
ma_data %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = stimuli_actor)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by stimuli_actor") 
```

```{r}
m_age_stimuli_actor <- rma.mv(d_calc ~ mean_age + stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
m_age_stimuli_actor_interaction <- rma.mv(d_calc ~ mean_age * stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_stimuli_actor)
summary(m_age_stimuli_actor_interaction)
```

### <36, young

```{r}
ma_data_young_only %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = stimuli_actor)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by stimuli_actor, young only") 
```

```{r}
m_age_stimuli_actor_young <- rma.mv(d_calc ~ mean_age + stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
m_age_stimuli_actor_interaction_young <- rma.mv(d_calc ~ mean_age * stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_stimuli_actor_young)
summary(m_age_stimuli_actor_interaction_young)
```

### >= 36, old 

```{r}
ma_data_old %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = stimuli_actor)) +
  geom_point() +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by stimuli_actor, old only") 
```

```{r}
m_age_stimuli_actor_old <- rma.mv(d_calc ~ mean_age + stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
m_age_stimuli_actor_interaction_old <- rma.mv(d_calc ~ mean_age * stimuli_actor, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_age_stimuli_actor_old)
summary(m_age_stimuli_actor_interaction_old)
```


## age with presentation_type  {.tabset}
Decided to only compare asynchronous and immediate after:
```{r}
ma_data %>% 
  count(presentation_type)
```

```{r}
ma_data_pt <- ma_data %>% 
  filter(presentation_type != "simultaneous") 

ma_data_pt_young <- ma_data_pt %>% 
  mutate(age_months = mean_age/30.44) %>% 
    filter(age_months < 36) 


ma_data_pt_old <- ma_data_pt %>% 
  mutate(age_months = mean_age/30.44) %>% 
    filter(age_months > 36 | age_months == 36) 

```

### all
```{r}
ma_data_pt %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1,  color = presentation_type)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by presentation type") 
```

```{r}
m_age_pt <- rma.mv(d_calc ~ mean_age + presentation_type, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_pt)

m_age_pt_interaction <- rma.mv(d_calc ~ mean_age * presentation_type, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_pt)

summary(m_age_pt)
summary(m_age_pt_interaction)
```

### <36, young
```{r}
ma_data_pt_young %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1,  color = presentation_type)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by presentation type, young only") 
```

```{r}
m_data_pt_young <- rma.mv(d_calc ~ mean_age + presentation_type, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_pt_young)

m_age_pt_interaction_young <- rma.mv(d_calc ~ mean_age * presentation_type, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_pt_young)

summary(m_age_pt)
summary(m_age_pt_interaction)
```

### >= 36, old 
```{r}
ma_data_pt_old %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1,  color = presentation_type)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by presentation type, young only") 
```

## age with character_identification  {.tabset}
### all 
```{r}
ma_data %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = character_identification)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by character_identification") 
```

```{r}
m_age_ci <- rma.mv(d_calc ~ mean_age + character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
m_age_stimuli_ci_interaction <- rma.mv(d_calc ~ mean_age * character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_ci)
summary(m_age_stimuli_ci_interaction)
```

### <36, young

```{r}
ma_data_young_only %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = character_identification)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by character_identification, young only") 
```

```{r}
m_age_ci_young <- rma.mv(d_calc ~ mean_age + character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
m_age_ci_interaction_young <- rma.mv(d_calc ~ mean_age * character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_ci_young)
summary(m_age_ci_interaction_young)
```
### >= 36, old 
```{r}
ma_data_old %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = character_identification)) +
  geom_point() +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by character_identification, old only") 
```



## age with practice_phase {.tabset}
### all 
```{r}
ma_data %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = practice_phase)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by practice_phase") 
```

```{r}
m_age_pf <- rma.mv(d_calc ~ mean_age + character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
m_age_pf_interaction <- rma.mv(d_calc ~ mean_age * character_identification, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_ci)
summary(m_age_stimuli_ci_interaction)
```

### <36, young

```{r}
ma_data_young_only %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = practice_phase)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by practice_phase, young only") 
```

```{r}
m_age_pf_young <- rma.mv(d_calc ~ mean_age + practice_phase, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
m_age_pf_interaction_young <- rma.mv(d_calc ~ mean_age * practice_phase, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_pf_young)
summary(m_age_pf_interaction_young)
```
### >= 36, old 
```{r}
ma_data_old %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = practice_phase)) +
  geom_point() +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by practice_phase, old only") 
```

## age with test_mass_or_distributed {.tabset}
### all 
```{r}
ma_data %>% 
  mutate(age_months = mean_age/30.44) %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = test_mass_or_distributed)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by test type") 
```

```{r}
m_age_tt <- rma.mv(d_calc ~ mean_age + test_mass_or_distributed, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
m_age_tt_interaction <- rma.mv(d_calc ~ mean_age * test_mass_or_distributed, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_age_tt)
summary(m_age_tt_interaction)
```

### <36, young

```{r}
ma_data_young_only %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = test_mass_or_distributed)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by test_mass_or_distributed, young only") 
```

```{r}
m_age_tt_young <- rma.mv(d_calc ~ mean_age + test_mass_or_distributed, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
m_age_tt_interaction_young <- rma.mv(d_calc ~ mean_age * test_mass_or_distributed, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young_only)
summary(m_age_tt_young)
summary(m_age_tt_interaction_young)
```

### >= 36, old 
```{r}
ma_data_old %>% 
  mutate(age_months = mean_age/30.44) %>%
  ggplot(aes(x = age_months, y = d_calc, size = n_1, color = test_mass_or_distributed)) +
  geom_point() +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (days), breakdown by test_mass_or_distributed, old only") 
```

## repetition only {.tabset}
### repetition only 
```{r}
ma_data %>% 
  ggplot(mapping = aes(x = n_repetitions_sentence, y = d_calc)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("number of repetition per novel verb") +
  ggtitle("Syntactical Bootstrapping effect size vs. number of repetitions for verb") +
  theme_classic() +
  theme(legend.position = "none")

```
```{r}
m_rep <- rma.mv(d_calc ~ n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_rep)
```

### repetition only, young 
```{r}
ma_data_young %>% 
  ggplot(mapping = aes(x = n_repetitions_sentence, y = d_calc)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("number of repetition per novel verb") +
  ggtitle("Syntactical Bootstrapping effect size vs. number of repetitions for verb") +
  theme_classic() +
  theme(legend.position = "none")
```

```{r}
m_rep_young <- rma.mv(d_calc ~ n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young)
summary(m_rep_young)
```

### repetition only, old 
```{r}
ma_data_old %>% 
  ggplot(mapping = aes(x = n_repetitions_sentence, y = d_calc)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("number of repetition per novel verb") +
  ggtitle("Syntactical Bootstrapping effect size vs. number of repetitions for verb") +
  theme_classic() +
  theme(legend.position = "none")
```

```{r}
m_rep_old <- rma.mv(d_calc ~ n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_rep_old)
```

## repetition with age
### correlation
### all
```{r}
m_rep_age <- rma.mv(d_calc ~ mean_age + n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
m_rep_age_interaction <- rma.mv(d_calc ~ mean_age*n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data)
summary(m_rep_age)
summary(m_rep_age_interaction)

```

### young, <36
```{r}
m_rep_age_young <- rma.mv(d_calc ~ mean_age + n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young)
m_rep_age_interaction_young <- rma.mv(d_calc ~ mean_age*n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_young)
summary(m_rep_age_young)
summary(m_rep_age_interaction_young)

```


### old > 36
```{r}
m_rep_age_old <- rma.mv(d_calc ~ mean_age + n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
m_rep_age_interaction_old <- rma.mv(d_calc ~ mean_age*n_repetitions_sentence , V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_old)
summary(m_rep_age_old)
summary(m_rep_age_interaction_old)

```



## vocab {.tabset}
### vocab (median)
```{r}
ma_data_with_vocab <- ma_data %>% 
  mutate(vocab = case_when(!is.na(productive_vocab_median) ~ productive_vocab_median,
                           !is.na(productive_vocab_mean) ~ productive_vocab_mean,
                            TRUE ~ NA_real_),
         vocab_source = case_when(!is.na(productive_vocab_median) ~ "median",
                           !is.na(productive_vocab_mean) ~ "mean",
                            TRUE ~ NA_character_)) 

ma_data_with_vocab %>%
  ggplot(aes(x = productive_vocab_median, y = d_calc)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic()
```

```{r}
m_vocab <- rma.mv(d_calc ~ productive_vocab_median, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_with_vocab)
summary(m_vocab)
```


### age comparison 
```{r}
ma_data_with_vocab_age <- ma_data_with_vocab %>% 
  filter(vocab_source == "median" &
        !is.na(vocab)) 

ma_data_with_vocab_age %>% 
  ggplot(aes(x = mean_age, y = d_calc)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic()
  
```

```{r}
m_age_with_vocab <- rma.mv(d_calc ~ mean_age, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_with_vocab_age)
summary(m_age_with_vocab)
```

### < 36, young
```{r}
ma_data_with_vocab_age_young <- ma_data_with_vocab_age %>% 
  mutate(age_months = mean_age/30.44) %>% 
  filter(age_months < 36) 


ma_data_with_vocab_age_young %>% 
  ggplot(aes(x = productive_vocab_median, y = d_calc, size = n_1)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. vocab (months)") 
    
```
```{r}
m_age_with_vocab_young <- rma.mv(d_calc ~ productive_vocab_median, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_with_vocab_age_young)
summary(m_age_with_vocab_young)
```

### < 36, young, age comparison
```{r}

ma_data_with_vocab_age_young %>% 
  ggplot(aes(x = age_months, y = d_calc, size = n_1)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylab("Effect Size") +
  xlab("Age (days)") +
  ggtitle("Syntactical Bootstrapping effect size vs. Age (months)") 
    
```

```{r}
m_age_with_vocab_young <- rma.mv(d_calc ~ mean_age, V = d_var_calc,
                            random = ~ 1 | short_cite, data = ma_data_with_vocab_age_young)
summary(m_age_with_vocab)
```
### correlationt est
```{r}
cor.test(ma_data_with_vocab$mean_age,
         ma_data_with_vocab$productive_vocab_median)
```


# contingency table 
```{r}
ALL_CATEGORICAL_VARS <- c("test_type","presentation_type",
                      "agent_argument_type_clean", "patient_argument_type_clean", 
                     "stimuli_modality", "stimuli_actor", "character_identification", "practice_phase", "test_mass_or_distributed", "test_method")




get_cross_counts <- function(args, df){
  var1 = args[[1]]
  var2 = args[[2]]
  
  if (var1 != var2){
  
  df %>%
    select_(var1, var2) %>%
    rename(v1 = var1, 
          v2 = var2) %>%
    count(v1, v2) %>%
    mutate(v1_long = glue("{var1}/{v1}"),
           v2_long = glue("{var2}/{v2}"))  %>%
    select(v1_long, v2_long, n) 

  }
}

all_pair_counts <- list(ALL_CATEGORICAL_VARS,
                        ALL_CATEGORICAL_VARS) %>%
  cross() %>%
  map_df(get_cross_counts, ma_data) %>%
  complete(v1_long, v2_long, fill = list(n = 0)) %>%
  filter(v1_long != v2_long)


  all_counts_wide <- all_pair_counts %>%
    pivot_wider(names_from = v2_long, values_from = n) 
  

  all_counts_wide_matrix <- all_counts_wide %>%
    select(-v1_long) %>%
    as.matrix()
  
  row.names(all_counts_wide_matrix) <-   all_counts_wide$v1_long
  heatmaply(all_counts_wide_matrix,
            fontsize_row = 8,
            fontsize_col = 8)
```




# Model selections??
http://www.metafor-project.org/doku.php/tips:model_selection_with_glmulti_and_mumin
```{r}
eval(metafor:::.MuMIn)

ma_data

full <- rma.mv(d_calc, d_var_calc, mods = ~ mean_age + agent_argument_type_clean + patient_argument_type_clean + stimuli_modality + stimuli_actor + presentation_type + test_mass_or_distributed + practice_phase + character_identification + n_repetitions_sentence + n_repetitions_video + test_method,
            data=ma_data, method="ML")

res <- dredge(full, trace=2)
subset(res, delta <= 2, recalc.weights=FALSE)



```

```{r}
res
```

```{r}

rma.glmulti <- function(formula,data)
  {rma.mv(formula, d_var_calc, data=ma_data, method="ML")
}
res <- glmulti(d_calc ~mean_age + agent_argument_type_clean + patient_argument_type_clean + stimuli_modality + stimuli_actor + presentation_type + test_mass_or_distributed + practice_phase + character_identification + n_repetitions_sentence + n_repetitions_video + test_method, data=ma_data,
               level=1, fitfunction=rma.glmulti, crit="aicc", confsetsize=32)
print(res)

top <- weightable(res)
top <- top[top$aicc <= min(top$aicc) + 2,]
top
summary(res@objects[[1]])
plot(res, type="s")


```

```{r}
summary(res@objects[[2]])
plot(res, type="s")
```


```{r}
eval(metafor:::.glmulti)
coef(res)
mmi <- as.data.frame(coef(res))
mmi <- data.frame(Estimate=mmi$Est, SE=sqrt(mmi$Uncond), Importance=mmi$Importance, row.names=row.names(mmi))
mmi$z <- mmi$Estimate / mmi$SE
mmi$p <- 2*pnorm(abs(mmi$z), lower.tail=FALSE)
names(mmi) <- c("Estimate", "Std. Error", "Importance", "z value", "Pr(>|z|)")
mmi$ci.lb <- mmi[[1]] - qnorm(.975) * mmi[[2]]
mmi$ci.ub <- mmi[[1]] + qnorm(.975) * mmi[[2]]
mmi <- mmi[order(mmi$Importance, decreasing=TRUE), c(1,2,4:7,3)]
round(mmi, 4)
```







