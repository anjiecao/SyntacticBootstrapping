---
title: "poweranalysis"
author: "anjie"
date: "6/10/2021"
output: html_document
---

```{r}
library(tidyverse)
library(here)
library(metafor)

d <- read_csv(here("data/processed/syntactic_bootstrapping_tidy_data.csv"))

```

```{r}
model <- rma.mv(d_calc ~ sentence_structure, 
                  V = d_var_calc,
                  random = ~ 1 | short_cite/same_infant/row_id,
                  method = "ML",
                  data = d)


X = model.matrix(age_model)
#Â And for a mixed model procedure and a moderate degree of heterogeneity
V_star = diag(d$d_var_calc + 2*(d$d_var_calc)/3)
SIGMA_star = solve(crossprod(X,solve(V_star))%*%X)

criterial_value_on_z = qnorm(0.975)
predictor_names = c("SS")

estimated_power = tibble(
  es = rep(seq(0.01,1,0.01),3),
  predictor = rep(predictor_names, each = length(es)/length(predictor_names)),
  es_variance = rep(c(SIGMA_star[2,2]), 
                    each = length(es)/length(predictor_names)),
  power = 1 - pnorm(criterial_value_on_z - es/sqrt(es_variance))+
      pnorm(-criterial_value_on_z - es/sqrt(es_variance))
)
estimated_power$predictor  = factor(estimated_power$predictor, 
                                    labels = c("SS"))
stimulus_power = ggplot(estimated_power,aes(x = es, y = power, lty = predictor, color = predictor))+
  geom_line(lwd = 1.5)+theme_cowplot()+xlab("Effect size")+ylab("Power")+
  theme(legend.title=element_blank(), legend.position = c(0.5,0.5))+
  scale_color_manual(values = 
                c(brewer.pal(5,"Set1")[1],brewer.pal(5,"Set1")[3],brewer.pal(5,"Set1")[4]))
stimulus_power
```

