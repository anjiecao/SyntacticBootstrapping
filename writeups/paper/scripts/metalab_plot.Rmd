---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(metafor)
library(metalabr)
library(here)
SB_DATA <- read_csv(here("data/processed/syntactic_bootstrapping_tidy_data.csv"))
SB_DATA <- SB_DATA %>% 
  mutate(mean_age_1 = mean_age, 
         unique_row = row_number())

```

```{r}
ml_dataset_info <- metalabr::get_metalab_dataset_info()
ml_data <- metalabr::get_metalab_data(ml_dataset_info)
```
```{r}
MAPPING_STUDIES <- c("Mutual exclusivity", 
                     "Sound symbolism",
                     "Cross-situational word learning",
                     "Gaze following")


ME_info <- ml_dataset_info %>% 
  filter(name == "Mutual exclusivity")
SS_info <- ml_dataset_info %>% 
  filter(name == "Sound symbolism")
XS_info <- ml_dataset_info %>% 
  filter(name == "Cross-situational word learning")
GF_info <- ml_dataset_info %>% 
  filter(name == "Gaze following")

ME_data <- metalabr::get_metalab_data(ME_info) %>% 
  mutate(dataset = "Mutual exclusivity")
SS_data <- metalabr::get_metalab_data(SS_info) %>% 
  mutate(dataset = "Sound symbolism")
XS_data <- metalabr::get_metalab_data(XS_info) %>% 
  mutate(dataset = "Cross-situational word learning")
GF_data <- metalabr::get_metalab_data(GF_info) %>% 
  mutate(dataset = "Gaze following")

ALL_data <- bind_rows(ME_data, 
                      SS_data, 
                      XS_data, 
                      GF_data)
ALL_data
```

```{r}



fit_model <- function(data, dataset_name){

  null_model <- rma.mv(d_calc ~ 1, 
                  V = d_var_calc,
                  random = ~ 1 | short_cite/same_infant/unique_row,
                  method = "REML",
                  data = data)
  
  age_model <- rma.mv(d_calc ~ mean_age_1, 
                  V = d_var_calc,
                  random = ~ 1 | short_cite/same_infant/unique_row,
                  method = "REML",
                  data = data)

  
  params <- data.frame(dataset_name =  dataset_name,
                       null_estimate = null_model$b[1],
                       null_estimate.cil = null_model$ci.lb[1],
                       null_estimate.cih = null_model$ci.ub[1],
                       null_z = null_model$zval[1],
                       null_p = null_model$pval[1],
                       
                       age_estimate = age_model$b[1],
                       age_estimate.cil = age_model$ci.lb[1],
                       age_estimate.cih = age_model$ci.ub[1],
                       age_z = age_model$zval[1],
                       age_p = age_model$pval[1]
                       )
  
  return(params)

}

get_model_results <- function(
                              dataset_name){
  
  ml_dataset_info <- metalabr::get_metalab_dataset_info()

  ME_info <- ml_dataset_info %>% 
  filter(name == "Mutual exclusivity")
SS_info <- ml_dataset_info %>% 
  filter(name == "Sound symbolism")
XS_info <- ml_dataset_info %>% 
  filter(name == "Cross-situational word learning")
GF_info <- ml_dataset_info %>% 
  filter(name == "Gaze following")

ME_data <- metalabr::get_metalab_data(ME_info) %>% 
  mutate(dataset = "Mutual exclusivity")
SS_data <- metalabr::get_metalab_data(SS_info) %>% 
  mutate(dataset = "Sound symbolism")
XS_data <- metalabr::get_metalab_data(XS_info) %>% 
  mutate(dataset = "Cross-situational word learning")
GF_data <- metalabr::get_metalab_data(GF_info) %>% 
  mutate(dataset = "Gaze following")

ALL_data <- bind_rows(ME_data, 
                      SS_data, 
                      XS_data, 
                      GF_data)

  
  mod_data <- ALL_data %>% 
    filter(dataset == dataset_name) 
  
  mod_results <- fit_model(mod_data, dataset_name)
  
  return (mod_results)
  
  
}


```


```{r}
MAPPING_STUDIES <- c("Mutual exclusivity", 
                     "Sound symbolism",
                     "Cross-situational word learning",
                     "Gaze following")

all_models_res <- map_df(MAPPING_STUDIES, get_model_results)
```



```{r}
SB_results <- fit_model(SB_DATA, "Syntactic Bootstrapping")
all_models_res <- bind_rows(all_models_res, SB_results)

```

```{r}
all_models_tidy <- all_models_res %>% 
  pivot_longer(
    null_estimate:age_p, 
    names_to = "model_name",
    values_to = "value"
  ) %>% 
  mutate(
    model_type = case_when(
      grepl("null", model_name) ~ "null", 
      grepl("age", model_name) ~ "age"
    ), 
    value_type = gsub(".*_", "", model_name)
  ) %>%  
  pivot_wider(
    names_from = value_type, 
    values_from = value
  ) %>% 
  group_by(dataset_name, model_type) %>%
  mutate_at(vars(-group_cols()), function(x) {x[!is.na(x)][1]}) %>%
  distinct() %>% 
  select(-model_name)
```

```{r}
all_models_tidy %>% 
  ggplot(aes(x = fct_reorder(dataset_name, -estimate), color = model_type, 
            y = estimate, 
            ymin = estimate.cil, 
            ymax = estimate.cih, 
            group = model_type)) + 
    geom_pointrange(size = 1, position = position_dodge(0.5)) + 
    scale_color_manual(values = c("grey", "red")) + 
    scale_alpha_manual(values = c(0, 1)) + 
    geom_hline(yintercept = 0, color = "black", linetype="dashed")+
    coord_flip() + 
    theme(
      axis.line = element_line(size = 1.2),
      axis.ticks = element_line(size = 1),
      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank()) + 
    xlab("") + 
    ylab("Estimate") 
  
```


```{r}
all_models_tidy %>% 
  ggplot(aes(x = fct_reorder(dataset_name, -estimate), color = model_type, 
            y = estimate, 
            ymin = estimate.cil, 
            ymax = estimate.cih, 
            group = model_type)) + 
    geom_pointrange(size = 1) + 
    scale_color_manual(values = c("grey", "red")) + 
    scale_alpha_manual(values = c(0, 1)) + 
    geom_hline(yintercept = 0, color = "black", linetype="dashed")+
    coord_flip() + 
    theme(
      axis.line = element_line(size = 1.2),
      axis.ticks = element_line(size = 1),
      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank()) + 
    xlab("") + 
    ylab("Estimate") 
```

